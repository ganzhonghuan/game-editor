<!DOCTYPE html>
<!-- saved from url=(0091)http://101.132.252.127/config/1_1_levelgridconfig.html?blockType=12&levelHeight=8&winType=1 -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯é…ç½®å…³å¡ç¼–è¾‘å™¨</title>
    <style>
        /* æ ·å¼éƒ¨åˆ†ä¿æŒä¸å˜ */
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; font-family: Arial; }
        .form-group { margin-bottom: 15px; display: flex; align-items: center; }
        label { display: inline-block; width: 180px; margin-right: 10px; }
        input, select { flex: 1; padding: 6px; max-width: 200px; }
        .grid-container { display: grid; gap: 2px; background: #333; padding: 5px; }
        .grid-cell { 
            width: 30px; height: 30px; 
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: bold; cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }
        .cell-0 { background: white; color: #333; }
        .cell-1 { background: #dad9d9; color: #333; }
        .cell-2 { background: #616161; color: white; }
        .cell-11 { background: #4CAF50; color: white; }
        .cell-12 { background: #00BCD4; color: white; }
        .cell-13 { background: #2196F3; color: white; }
        .cell-14 { background: #dbdbdb; color: #333;}
        .cell-15 { background: #9C27B0; color: white; }
        .cell-16 { background: #FFEB3B; color: #333; }
        .cell-17 { background: #F44336; color: white; }
        .error-marker {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 2px solid #ff0000;
            top: -2px;
            left: -2px;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { opacity: 0.8; }
            50% { opacity: 0.4; }
            100% { opacity: 0.8; }
        }
        .coord {
            position: absolute;
            font-size: 6px;
            bottom: 1px;
            right: 1px;
            color: #666;
        }
        .counter { margin: 10px 0; padding: 8px; border-radius: 4px; }
        .counter.ok { background: #E8F5E9; color: #2E7D32; }
        .counter.over { background: #FFEBEE; color: #C62828; }
        button { 
            padding: 8px 16px; 
            margin-right: 10px; 
            background: #2F27CE; 
            color: white; 
            border: none; 
            cursor: pointer;
            border-radius: 4px;
        }
        #configOutput {
            background: #f5f5f5;
            padding: 15px;
            margin-top: 20px;
            white-space: pre-wrap;
            border-radius: 4px;
            font-family: Consolas, monospace;
        }
        .diamond-setting { display: none; }
        .color-legend { padding: 10px; background: #f5f5f5; margin: 10px 0; }
        .color-box { width: 12px; height: 12px; display: inline-block; margin-right: 5px; }
        .diamond-colors { display: flex; gap: 10px; margin: 10px 0; }
        .diamond-colors input { width: 60px; }
        #diamondCounter {
        display: block;
        margin: 10px 0;
        padding: 8px;
        border-radius: 4px;
        }
        #diamondWarning {
            font-size: 14px;
            vertical-align: middle;
        }
        #diamondWarning:before {
            content: "âš ï¸ ";
            margin-right: 4px;
        }
        .config-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 14px;
        }
        .config-table th, .config-table td {
            border: 1px solid #ddd;
            padding: 8px;
            min-width: 40px;
            text-align: center;
        }
        .config-table th {
            background-color: #2F27CE;
            color: white;
        }
        .config-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        #gridError {
        margin-top: -8px;
        border: 1px solid #FFB74D;
        padding: 10px;
        font-size: 13px;
        }
        #gridError div {
          margin: 3px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-group">
            <label>èƒœåˆ©æ¡ä»¶ï¼š</label>
            <select id="winType">
                <option value="1">ç§¯åˆ†é€šå…³</option>
                <option value="2">æ”¶é›†é€šå…³</option>
            </select>
        </div>

        <div class="form-group" id="diamondSetting" style="display:none;">
            <div style="width:100%">
                <div class="diamond-colors">
                    <div>
                        é¢œè‰²1
                        <input type="number" id="color1" min="11" max="17">
                        é¢œè‰²2
                        <input type="number" id="color2" min="11" max="17">
                        é¢œè‰²3
                        <input type="number" id="color3" min="11" max="17">
                    </div>
                </div>
            </div>
        </div>

        <div class="form-group" id="diamondCountGroup" style="display:none;">
            <label>é’»çŸ³ç”Ÿæˆæ•°é‡ï¼š</label>
            <input type="number" id="diamondCount" value="5" min="1">
        </div>

        <div class="form-group">
            <label>æ¨ªå‘å—æ•°ï¼š</label>
            <select id="blockType">
                <option value="12">12</option>
                <option value="18">18</option>
                <option value="24">24</option>
            </select>
        </div>

        <div class="form-group">
            <label>çºµå‘å±‚æ•°ï¼š</label>
            <select id="levelHeight">
                <option value="8">8</option>
                <option value="12">12</option>
            </select>
        </div>

        <div class="form-group">
            <label>æœ€å¤§éšœç¢ç‰©ï¼š</label>
            <input type="number" id="maxObstacles" value="0" min="0" max="50">
        </div>


        
        <div class="color-legend">
            <span><div class="color-box" style="background:#4CAF50"></div>11=ç»¿</span>
            <span><div class="color-box" style="background:#00BCD4"></div>12=è“å…‰</span>
            <span><div class="color-box" style="background:#2196F3"></div>13=è“</span>
            <span><div class="color-box" style="background:#dbdbdb"></div>14=ç™½</span>
            <span><div class="color-box" style="background:#9C27B0"></div>15=ç´«</span>
            <span><div class="color-box" style="background:#FFEB3B"></div>16=é»„</span>
            <span><div class="color-box" style="background:#F44336"></div>17=çº¢</span>
        </div>
        
        <div class="form-group">
            <div style="border: 2px solid #ddd; padding: 15px; border-radius: 8px; width: 100%;">
                <h3 style="margin-top:0;">å…³å¡ç¼–è¾‘å™¨ 
                    <button onclick="initGrid()">ğŸ”„ é‡ç½®</button>
                    <button onclick="optimizedFill()">ğŸ² æ™ºèƒ½å¡«å……</button>
                </h3>
                <div class="grid-container" id="gridContainer" style="grid-template-columns: repeat(12, 30px);"><div class="grid-cell cell-0">0<div class="coord">0,0</div></div><div class="grid-cell cell-0">0<div class="coord">1,0</div></div><div class="grid-cell cell-0">0<div class="coord">2,0</div></div><div class="grid-cell cell-0">0<div class="coord">3,0</div></div><div class="grid-cell cell-0">0<div class="coord">4,0</div></div><div class="grid-cell cell-0">0<div class="coord">5,0</div></div><div class="grid-cell cell-0">0<div class="coord">6,0</div></div><div class="grid-cell cell-0">0<div class="coord">7,0</div></div><div class="grid-cell cell-0">0<div class="coord">8,0</div></div><div class="grid-cell cell-0">0<div class="coord">9,0</div></div><div class="grid-cell cell-0">0<div class="coord">10,0</div></div><div class="grid-cell cell-0">0<div class="coord">11,0</div></div><div class="grid-cell cell-0">0<div class="coord">0,1</div></div><div class="grid-cell cell-0">0<div class="coord">1,1</div></div><div class="grid-cell cell-0">0<div class="coord">2,1</div></div><div class="grid-cell cell-0">0<div class="coord">3,1</div></div><div class="grid-cell cell-0">0<div class="coord">4,1</div></div><div class="grid-cell cell-0">0<div class="coord">5,1</div></div><div class="grid-cell cell-0">0<div class="coord">6,1</div></div><div class="grid-cell cell-0">0<div class="coord">7,1</div></div><div class="grid-cell cell-0">0<div class="coord">8,1</div></div><div class="grid-cell cell-0">0<div class="coord">9,1</div></div><div class="grid-cell cell-0">0<div class="coord">10,1</div></div><div class="grid-cell cell-0">0<div class="coord">11,1</div></div><div class="grid-cell cell-0">0<div class="coord">0,2</div></div><div class="grid-cell cell-0">0<div class="coord">1,2</div></div><div class="grid-cell cell-0">0<div class="coord">2,2</div></div><div class="grid-cell cell-0">0<div class="coord">3,2</div></div><div class="grid-cell cell-0">0<div class="coord">4,2</div></div><div class="grid-cell cell-0">0<div class="coord">5,2</div></div><div class="grid-cell cell-0">0<div class="coord">6,2</div></div><div class="grid-cell cell-0">0<div class="coord">7,2</div></div><div class="grid-cell cell-0">0<div class="coord">8,2</div></div><div class="grid-cell cell-0">0<div class="coord">9,2</div></div><div class="grid-cell cell-0">0<div class="coord">10,2</div></div><div class="grid-cell cell-0">0<div class="coord">11,2</div></div><div class="grid-cell cell-0">0<div class="coord">0,3</div></div><div class="grid-cell cell-0">0<div class="coord">1,3</div></div><div class="grid-cell cell-0">0<div class="coord">2,3</div></div><div class="grid-cell cell-0">0<div class="coord">3,3</div></div><div class="grid-cell cell-0">0<div class="coord">4,3</div></div><div class="grid-cell cell-0">0<div class="coord">5,3</div></div><div class="grid-cell cell-0">0<div class="coord">6,3</div></div><div class="grid-cell cell-0">0<div class="coord">7,3</div></div><div class="grid-cell cell-0">0<div class="coord">8,3</div></div><div class="grid-cell cell-0">0<div class="coord">9,3</div></div><div class="grid-cell cell-0">0<div class="coord">10,3</div></div><div class="grid-cell cell-0">0<div class="coord">11,3</div></div><div class="grid-cell cell-0">0<div class="coord">0,4</div></div><div class="grid-cell cell-0">0<div class="coord">1,4</div></div><div class="grid-cell cell-0">0<div class="coord">2,4</div></div><div class="grid-cell cell-0">0<div class="coord">3,4</div></div><div class="grid-cell cell-0">0<div class="coord">4,4</div></div><div class="grid-cell cell-0">0<div class="coord">5,4</div></div><div class="grid-cell cell-0">0<div class="coord">6,4</div></div><div class="grid-cell cell-0">0<div class="coord">7,4</div></div><div class="grid-cell cell-0">0<div class="coord">8,4</div></div><div class="grid-cell cell-0">0<div class="coord">9,4</div></div><div class="grid-cell cell-0">0<div class="coord">10,4</div></div><div class="grid-cell cell-0">0<div class="coord">11,4</div></div><div class="grid-cell cell-0">0<div class="coord">0,5</div></div><div class="grid-cell cell-0">0<div class="coord">1,5</div></div><div class="grid-cell cell-0">0<div class="coord">2,5</div></div><div class="grid-cell cell-0">0<div class="coord">3,5</div></div><div class="grid-cell cell-0">0<div class="coord">4,5</div></div><div class="grid-cell cell-0">0<div class="coord">5,5</div></div><div class="grid-cell cell-0">0<div class="coord">6,5</div></div><div class="grid-cell cell-0">0<div class="coord">7,5</div></div><div class="grid-cell cell-0">0<div class="coord">8,5</div></div><div class="grid-cell cell-0">0<div class="coord">9,5</div></div><div class="grid-cell cell-0">0<div class="coord">10,5</div></div><div class="grid-cell cell-0">0<div class="coord">11,5</div></div><div class="grid-cell cell-0">0<div class="coord">0,6</div></div><div class="grid-cell cell-0">0<div class="coord">1,6</div></div><div class="grid-cell cell-0">0<div class="coord">2,6</div></div><div class="grid-cell cell-0">0<div class="coord">3,6</div></div><div class="grid-cell cell-0">0<div class="coord">4,6</div></div><div class="grid-cell cell-0">0<div class="coord">5,6</div></div><div class="grid-cell cell-0">0<div class="coord">6,6</div></div><div class="grid-cell cell-0">0<div class="coord">7,6</div></div><div class="grid-cell cell-0">0<div class="coord">8,6</div></div><div class="grid-cell cell-0">0<div class="coord">9,6</div></div><div class="grid-cell cell-0">0<div class="coord">10,6</div></div><div class="grid-cell cell-0">0<div class="coord">11,6</div></div><div class="grid-cell cell-0">0<div class="coord">0,7</div></div><div class="grid-cell cell-0">0<div class="coord">1,7</div></div><div class="grid-cell cell-0">0<div class="coord">2,7</div></div><div class="grid-cell cell-0">0<div class="coord">3,7</div></div><div class="grid-cell cell-0">0<div class="coord">4,7</div></div><div class="grid-cell cell-0">0<div class="coord">5,7</div></div><div class="grid-cell cell-0">0<div class="coord">6,7</div></div><div class="grid-cell cell-0">0<div class="coord">7,7</div></div><div class="grid-cell cell-0">0<div class="coord">8,7</div></div><div class="grid-cell cell-0">0<div class="coord">9,7</div></div><div class="grid-cell cell-0">0<div class="coord">10,7</div></div><div class="grid-cell cell-0">0<div class="coord">11,7</div></div></div>
                <div id="diamondCounter" class="counter">
                    <span id="diamondWarning" style="display:none;"></span>
                </div>
                <div id="obstacleCounter" class="counter"></div>
                <div id="gridError" class="counter over" style="display:none; background:#FFF3E0; color:#EF6C00;"></div>
            </div>
        </div>

        <div class="form-group">
            <button onclick="generateExcelConfig()">ğŸ’¾ ç”Ÿæˆé…ç½®</button>
            <button onclick="copyConfig()">ğŸ“‹ å¤åˆ¶æ•°æ®</button>
        </div>
        <div id="excelOutput"></div>
    </div>

<script>
    
// é…ç½®å‚æ•°
let currentGrid = [];
let DIAMOND_TYPES = [11, 12, 13];
const MAX_OBSTACLES = 50;
const MAX_WIDTH = 24;
const MAX_HEIGHT = 16;
let currentObstacles = 0;
let maxObstacles = 0;
let diamondTarget = 5;

// åˆå§‹åŒ–å‡½æ•°
function init() {
    const params = new URLSearchParams(window.location.search);
    
    // è®¾ç½®åŸºç¡€å‚æ•°
    setSelectValue('blockType', params.get('blockType') || '12');
    setSelectValue('levelHeight', params.get('levelHeight') || '8');
    setSelectValue('winType', params.get('winType') || '1');
    
    // å¤„ç†é¢œè‰²å‚æ•°
    if(params.get('winType') === '2') {
        document.getElementById('diamondSetting').style.display = 'block';
        document.getElementById('diamondCountGroup').style.display = 'block';
        DIAMOND_TYPES = [
            clampValue(parseInt(params.get('color1')), 11, 17, 11),
            clampValue(parseInt(params.get('color2')), 11, 17, 12),
            clampValue(parseInt(params.get('color3')), 11, 17, 13)
        ];
        document.getElementById('color1').value = DIAMOND_TYPES[0];
        document.getElementById('color2').value = DIAMOND_TYPES[1];
        document.getElementById('color3').value = DIAMOND_TYPES[2];
    }
    
    initGrid();
    addEventListeners();
    updateCounters();
    document.getElementById('obstacleCounter').style.display = 'block';
}

// è¾…åŠ©å‡½æ•°ï¼šè®¾ç½®ä¸‹æ‹‰æ¡†å€¼
function setSelectValue(id, value) {
    const select = document.getElementById(id);
    if(select) select.value = value;
}

// è¾…åŠ©å‡½æ•°ï¼šæ•°å€¼èŒƒå›´é™åˆ¶
function clampValue(value, min, max, defaultValue) {
    const num = Number.parseInt(value);
    if (isNaN(num)) return defaultValue;
    return Math.max(min, Math.min(max, num));
}
// æ·»åŠ äº‹ä»¶ç›‘å¬
function addEventListeners() {
    document.getElementById('winType').addEventListener('change', function() {
        document.getElementById('diamondSetting').style.display = 
            this.value === '2' ? 'block' : 'none';
    document.getElementById('diamondCountGroup').style.display = 
            this.value === '2' ? 'block' : 'none';
    });
    
    ['blockType', 'levelHeight'].forEach(id => {
        document.getElementById(id).addEventListener('change', () => {
            initGrid();
            updateCounters();
        });
    });
    
    document.getElementById('maxObstacles').addEventListener('input', function(e) {
        const rawValue = parseInt(e.target.value) || 0;
        maxObstacles = clampValue(rawValue, 0, 50, 0);  // å…è®¸0-50
        this.value = maxObstacles;  // æ˜¾ç¤ºä¿®æ­£åçš„å€¼
        scheduleRender();
    })
    
    document.getElementById('diamondCount').addEventListener('input', e => {
        diamondTarget = clampValue(e.target.value, 1, 50, 5);
        e.target.value = diamondTarget;
    });
}


// ä¿®æ”¹2ï¼šå¢å¼ºé¢œè‰²æ›´æ–°å‡½æ•°
function updateDiamondTypes() {
    DIAMOND_TYPES = [
        parseInt(document.getElementById('color1').value) || 11,
        parseInt(document.getElementById('color2').value) || 12,
        parseInt(document.getElementById('color3').value) || 13
    ].filter(v => v >= 11 && v <= 17).slice(0, 3); // ç¡®ä¿æœ€å¤š3ç§é¢œè‰²
}

document.getElementById('diamondCount').addEventListener('input', function() {
    diamondTarget = Math.min(Math.max(parseInt(this.value) || 5, 1), 50);
    this.value = diamondTarget;
    scheduleRender();
});

// åˆå§‹åŒ–ç½‘æ ¼
function initGrid() {
    const width = parseInt(document.getElementById('blockType').value);
    const height = parseInt(document.getElementById('levelHeight').value);
    
    currentGrid = Array.from({length: height}, () => 
        new Array(width).fill(0)
    );
    
    renderGrid();
    updateDiamondTypes()
}

// æ™ºèƒ½å¡«å……æ ¸å¿ƒé€»è¾‘
function optimizedFill() {
    updateDiamondTypes(); // æ–°å¢ä»£ç 
    const width = currentGrid[0].length;
    const height = currentGrid.length;
    const newGrid = Array.from({length: height}, () => new Uint8Array(width));

    // ç”ŸæˆåŸºç¡€æ–¹å—
    for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
            newGrid[y][x] = Math.random() < 0.6 && canPlaceBlock(x, y) ? 1 : 0;
        }
    }

    // æ”¾ç½®éšœç¢ç‰©
    let obstaclesAdded = 0;
    const obstacleCandidates = [];
    
    for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
            if (newGrid[y][x] === 1 && hasAdjacentBlocks(x, y, newGrid)) {
                obstacleCandidates.push({x, y});
            }
        }
    }
    
    while (obstaclesAdded < maxObstacles && obstacleCandidates.length > 0) {
        const index = Math.floor(Math.random() * obstacleCandidates.length);
        const {x, y} = obstacleCandidates.splice(index, 1)[0];
        newGrid[y][x] = 2;
        obstaclesAdded++;
    }

    // æ”¾ç½®é’»çŸ³
    if (isCollectMode()) {
        let diamondsPlaced = 0; // æ­£ç¡®å£°æ˜çš„å˜é‡
        const safeSpots = [];
        
        for (let y = 0; y < height; y++) {
            for (let x = 0; x < width; x++) {
                if (newGrid[y][x] === 0 && isDiamondSafe(x, y, newGrid)) {
                    safeSpots.push({x, y});
                }
            }
        }
        
        
        for (let i = safeSpots.length - 1; i >= 0 && diamondsPlaced < diamondTarget; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [safeSpots[i], safeSpots[j]] = [safeSpots[j], safeSpots[i]];
            const {x, y} = safeSpots[i];
            newGrid[y][x] = DIAMOND_TYPES[Math.floor(Math.random() * DIAMOND_TYPES.length)];
            diamondsPlaced++;  // è¿™é‡Œä¹Ÿè¦ä¿®æ”¹
            safeSpots.pop();
        }
    }

    currentGrid = newGrid;
    currentObstacles = obstaclesAdded;
    scheduleRender();
    updateCounters(); 
}

// è¾…åŠ©å‡½æ•°
function canPlaceBlock(x, y) {
    return !(
        (x >= 2 && currentGrid[y][x-1] === 1 && currentGrid[y][x-2] === 1) ||
        (y >= 2 && currentGrid[y-1][x] === 1 && currentGrid[y-2][x] === 1)
    );
}

function hasAdjacentBlocks(x, y, grid) {
    const directions = [[-1,0], [1,0], [0,-1], [0,1]];
    return directions.some(([dx, dy]) => 
        x + dx >= 0 && x + dx < grid[0].length &&
        y + dy >= 0 && y + dy < grid.length &&
        grid[y + dy][x + dx] === 1
    );
}

function isDiamondSafe(x, y, grid) {
    for (let dy = -1; dy <= 1; dy++) {
        for (let dx = -1; dx <= 1; dx++) {
            const nx = x + dx;
            const ny = y + dy;
            if (nx >= 0 && nx < grid[0].length && 
                ny >= 0 && ny < grid.length &&
                grid[ny][nx] === 1) {
                return false;
            }
        }
    }
    return true;
}

// æ¸²æŸ“ç³»ç»Ÿ
let renderDebounce;
function scheduleRender() {
    clearTimeout(renderDebounce);
    renderDebounce = setTimeout(renderGrid, 100);
}

function renderGrid() {
    const container = document.getElementById('gridContainer');
    const width = currentGrid[0]?.length || 12;
    container.style.gridTemplateColumns = `repeat(${width}, 30px)`;
    container.innerHTML = '';
    
    currentGrid.forEach((row, y) => {
        row.forEach((cell, x) => {
            const div = document.createElement('div');
            div.className = `grid-cell cell-${cell}`;
            div.innerHTML = `${cell}<div class="coord">${x},${y}</div>`;
            div.onclick = () => handleCellClick(x, y);
            container.appendChild(div);
        });
    });
}
// äº¤äº’åŠŸèƒ½
function handleCellClick(x, y) {
    const prevValue = currentGrid[y][x];
    const types = isCollectMode() ? [0, 1, 2, ...DIAMOND_TYPES] : [0, 1, 2];
    const newValue = types[(types.indexOf(prevValue) + 1) % types.length];
    
    // æ›´æ–°éšœç¢ç‰©è®¡æ•°
    if (prevValue === 2) currentObstacles--;
    if (newValue === 2) currentObstacles++;
    
    currentGrid[y][x] = newValue;
    scheduleRender();
    updateCounters();
}

// éªŒè¯ç³»ç»Ÿ
function validateLayout() {
    let isValid = true;
    const width = currentGrid[0].length;
    const height = currentGrid.length;

    // éªŒè¯æ–¹å—è¿ç»­æ€§è§„åˆ™
    for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
            if (currentGrid[y][x] === 1) {
                // æ¨ªå‘è¿ç»­æ£€æŸ¥
                if (x >= 2 && currentGrid[y][x-1] === 1 && currentGrid[y][x-2] === 1) {
                    isValid = false;
                    // markErrorCell(x, y);
                }
                // çºµå‘è¿ç»­æ£€æŸ¥
                if (y >= 2 && currentGrid[y-1][x] === 1 && currentGrid[y-2][x] === 1) {
                    isValid = false;
                    // markErrorCell(x, y);
                }
            }
        }
    }
    return isValid;
}

function markErrorCell(x, y) {
    const container = document.getElementById('gridContainer');
    const cellIndex = y * currentGrid[0].length + x;
    const cell = container.children[cellIndex];
    
    if (!cell.querySelector('.error-marker')) {
        const marker = document.createElement('div');
        marker.className = 'error-marker';
        cell.appendChild(marker);
        
        // 3ç§’åè‡ªåŠ¨ç§»é™¤æ ‡è®°
        setTimeout(() => {
            if (cell.contains(marker)) {
                cell.removeChild(marker);
            }
        }, 3000);
    }
}

// é…ç½®ç”Ÿæˆ
function generateExcelConfig() {
    const width = parseInt(document.getElementById('blockType').value);
    const layers = currentGrid.map(layer => 
        [...layer.slice(0, width), ...new Array(24 - width).fill(0)]
    );
    
    const tableHTML = `
    <table class="config-table">
        <tr>${['é…ç½®', ...Array.from({length:24}, (_,i)=>i+1)].map(h => `<th>${h}</th>`).join('')}</tr>
        ${layers.map((layer, i) => `
            <tr>
                <td>${i+1}</td>
                ${layer.map(cell => `<td>${cell}</td>`).join('')}
            </tr>
        `).join('')}
    </table>`;
    
    document.getElementById('excelOutput').innerHTML = tableHTML;
}

// å·¥å…·å‡½æ•°
function isCollectMode() {
    return document.getElementById('winType').value === '2';
}

function updateCounters() {
    // ç»Ÿè®¡å®é™…éšœç¢ç‰©æ•°é‡
    const actualObstacles = currentGrid.flat().reduce((acc, row) => acc + row.filter(c => c === 2).length, 0);
    const diamondWarning = document.getElementById('diamondWarning');
    // ç»Ÿè®¡å®é™…é’»çŸ³æ•°é‡
    let diamonds = 0;
    if (isCollectMode()) {
        diamonds = currentGrid.flat().reduce((acc, row) => 
            acc + row.filter(c => DIAMOND_TYPES.includes(c)).length, 0);
    }

    // æ›´æ–°éšœç¢ç‰©è®¡æ•°å™¨
    const obstacleElement = document.getElementById('obstacleCounter');
    obstacleElement.innerHTML = `éšœç¢ç‰©ï¼š${actualObstacles}/${maxObstacles}`;
    obstacleElement.className = `counter ${actualObstacles > maxObstacles ? 'over' : 'ok'}`;

    // æ›´æ–°é’»çŸ³è®¡æ•°å™¨
    const diamondElement = document.getElementById('diamondCounter');
    if (isCollectMode()) {
        diamondElement.innerHTML = `é’»çŸ³ï¼š${diamonds}/${diamondTarget}`;
        diamondElement.className = `counter ${diamonds !== diamondTarget ? 'over' : 'ok'}`;
        diamondElement.style.display = 'block';
    } else {
        diamondElement.style.display = 'none';
    }
    
     // æ–°å¢è¡Œåˆ—æ ¡éªŒ
    const errors = checkGridErrors();
    const errorDisplay = document.getElementById('gridError');
    
    if (errors.length > 0) {
        errorDisplay.style.display = 'block';
        errorDisplay.innerHTML = `
            <div>âš ï¸ é…ç½®é”™è¯¯ï¼š</div>
            ${errors.map(e => `<div>${e}</div>`).join('')}
        `;
    } else {
        errorDisplay.style.display = 'none';
    }
}

// æ–°å¢æ ¡éªŒå‡½æ•°
function checkGridErrors() {
    const errors = [];
    
    // æ£€æŸ¥è¡Œ
    currentGrid.forEach((row, y) => {
        if (row.every(cell => cell >= 1)) {
            errors.push(`ç¬¬${y+1}è¡Œä¸èƒ½å…¨éƒ¨æ˜¯æ–¹å—,ä¼šè‡ªåŠ¨æ¶ˆé™¤`);
        }
    });

    // æ£€æŸ¥åˆ—
    const colCount = currentGrid[0]?.length || 0;
    for (let x = 0; x < colCount; x++) {
        if (currentGrid.every(row => row[x] >= 1)) {
            errors.push(`ç¬¬${x+1}åˆ—ä¸èƒ½å…¨éƒ¨æ˜¯æ–¹å—,ä¼šè‡ªåŠ¨æ¶ˆé™¤`);
        }
    }

    return errors;
}


function copyConfig() {
    const blockType = parseInt(document.getElementById('blockType').value);
    
    // ç”ŸæˆExcelå…¼å®¹æ•°æ®
    const excelData = currentGrid.map((layer, index) => {
        const validData = Array.from(layer).slice(0, blockType);
        const padding = Array(24 - blockType).fill(0);
        return [index + 1, ...validData, ...padding];
    });
    
    // è½¬æ¢ä¸ºåˆ¶è¡¨ç¬¦åˆ†éš”æ–‡æœ¬
    const tsvContent = excelData.map(row => 
        row.join('\t')
    ).join('\n');

    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    const textarea = document.createElement('textarea');
    textarea.value = tsvContent;
    textarea.style.position = 'fixed';
    textarea.style.opacity = 0;
    document.body.appendChild(textarea);
    
    try {
        // ä¼ ç»Ÿå¤åˆ¶æ–¹æ³•
        textarea.select();
        textarea.setSelectionRange(0, 99999); // å…¼å®¹ç§»åŠ¨ç«¯
        
        if (document.execCommand('copy')) {
            alert('âœ… æ•°æ®å·²å¤åˆ¶ï¼å¯ç›´æ¥ç²˜è´´åˆ°Excel');
        } else {
            // é™çº§åˆ°æ‰‹åŠ¨é€‰æ‹©
            handleManualCopy(textarea);
        }
    } catch (err) {
        handleManualCopy(textarea);
    } finally {
        document.body.removeChild(textarea);
    }
    function handleManualCopy(element) {
        element.style.opacity = 1;
        element.style.position = 'fixed';
        element.style.top = '50%';
        element.style.left = '50%';
        element.style.transform = 'translate(-50%, -50%)';
        element.style.zIndex = 9999;
        element.style.background = 'white';
        element.style.padding = '20px';
        element.style.border = '2px solid #2F27CE';
        
        const confirmCopy = confirm('è¯·æŒ‰Ctrl+Cå¤åˆ¶å†…å®¹åå…³é—­æ­¤çª—å£');
        if (confirmCopy) {
            element.select();
        
            }
        }
 }

// æ–°å¢çš„blockTypeå’ŒlevelHeightç›‘å¬
document.getElementById('blockType').addEventListener('change', () => {
    initGrid();
    scheduleRender();
});

document.getElementById('levelHeight').addEventListener('change', () => {
    initGrid();
    scheduleRender();
});

document.querySelectorAll('.diamond-colors input').forEach(input => {
    input.addEventListener('change', function() {
        let value = parseInt(this.value) || 11;
        value = Math.min(Math.max(value, 11), 17);
        this.value = value;
        updateDiamondTypes();
        scheduleRender();
    });
});
document.getElementById('winType').dispatchEvent(new Event('change'));
initGrid();
document.addEventListener('DOMContentLoaded', init);
</script>

</body></html>